<!DOCTYPE HTML>
<html lang="en" class="flint sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Interop Modules - The Flint Wiki</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/flint.css">
        <link rel="stylesheet" href="../../theme/flint-highlight.css">
        <link rel="stylesheet" href="../../version_select.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "flint";
            const default_dark_theme = "flint";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('flint')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Flint Wiki</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="interop-modules"><a class="header" href="#interop-modules">Interop Modules</a></h1>
<p>Interop Modules (IMs) are the small individual pieces which are repsponsible for external languages. For this chapter we will focus on the <code>fip-c</code> IM. So, the project from the previous page is still broken and results in a compilation error, and we now want to fix that situation.</p>
<p>If you have not installed the <code>fip-c</code> IM yet, please follow the instructions in the <a href="user_guide/setup/4_fip_setup.html">FIP Setup</a> page and then continue on with this chapter when FIP is installed.</p>
<p>Now, with the <code>fip-c</code> IM installed, we can try to run the command again:</p>
<pre><code class="language-sh">flintc --file main.ft
</code></pre>
<p>Because compilation now succeeded, you will see absolutely no output, but the <code>main</code> executable has been created. When running the compiled program you will see this line printed to the console:</p>
<pre><code>Hello from C!
</code></pre>
<p>That was a lot to do just to get interop up and running, I admit that. But this whole process can (and will) be done using tools too. The <code>flint</code> executable (or maybe the <code>flintc</code> executable should handle that, I am not sure yet) will contain the capability to set up FIP for us. But, let's talk about all those directories, what they do and why they exist. First, let's talk about the <code>modules</code> directory and what the content in the <code>fip.toml</code> <em>actually</em> means. The <code>fip.toml</code> file has a very simple content, it's just these two lines:</p>
<pre><code class="language-toml">[fip-c]
enable = true
</code></pre>
<p>This essentially tells the compiler to search for the <code>fip-c</code> module in the <code>$HOME/.local/share/fip/modules/</code> (or <code>%LOCALAPPDATA%\fip\modules\</code> on Windows) directory and to start it when the compiler starts up. It essentially tells the compiler that the module exists and should be used by it. And then we have the <code>fip-c.toml</code> file. It only contains three entires, which are all not special at all:</p>
<pre><code class="language-toml">compiler = "gcc"
sources = ["hello.h"]
compile_flags = []
</code></pre>
<p>The <code>compiler</code> field tells the <code>fip-c</code> module which compiler to use to compile the C source file(s), in our case it's <code>gcc</code>.</p>
<p>If you are on Windows then you would need a C compiler and possibly a Developer PowerShell from the VS setup. So, you need to handle how to compile the extern language, like C, by yourself on Windows. On Linux, <code>gcc</code> is just available in the <code>PATH</code> variable and no setup is required from Your side.</p>
<p>Next we have the <code>sources</code> field. It's an array of filepaths to all the header or source files we interact with and we want to call into. You may noticed that we have not written any bindings or wrappers for the C functions at all, we just declared a function to be extern and then used it inside of Flint, and FIP figured out the rest for us. Okay, let's edit our header file and add another function to it, this time adding two numbers together:</p>
<pre><code>#include &lt;stdio.h&gt;

void hello() {
    printf("Hello from C!\n");
}

int add(int x, int y) {
    return x + y;
}
</code></pre>
<p>And then we also need to update the <code>main.ft</code> file:</p>
<pre><code class="language-ft">use Core.print

extern def hello();
extern def add(i32 x, i32 y) -&gt; i32;

def main():
    hello();
    print($"add(1, 8) = {add(1, 8)}\n");
</code></pre>
<p>And when we then try to compile this program we get yet another error:</p>
<blockquote>
<pre><code>Parse Error at test_files/test_minimal.ft:4:1
└─┬┤E0000│
4 │ extern def add(i32 x, i32 y) -&gt; i32;
┌─┴─┘
└─ Extern function could not be found in any FIP module
</code></pre>
</blockquote>
<div class="warning">
<p>This error message is not final, since it does not contain any information to <em>what</em> actually failed.</p>
<p>You need to use <code>flintc-debug</code> for the time being to actually find out what went wrong. When looking at the FIP logs, which start with <code>[Master]:</code> or <code>[Slave N]:</code> you can find out which symbols the <code>fip-c</code> module found and which symbol the Flint Compiler is searching for. You can find these lines in the output of the <code>flintc-debug</code> build:</p>
<pre><code>[Slave 1]: Found extern function: 'hello' at line 3
[Slave 1]:   Function Signature:
[Slave 1]:     name: hello
[Slave 1]: Found extern function: 'add' at line 7
[Slave 1]:   Function Signature:
[Slave 1]:     name: add
[Slave 1]:     arg[0]: mut i32
[Slave 1]:     arg[1]: mut i32
[Slave 1]:     ret[0]: mut i32
[Slave 1]: Found 2 extern functions in hello.h
</code></pre>
<p>And later on</p>
<pre><code>[Slave 1]: Symbol Request Recieved
[Slave 1]:   Function Signature:
[Slave 1]:     name: add
[Slave 1]:     arg[0]: const i32
[Slave 1]:     arg[1]: const i32
[Slave 1]:     ret[0]: mut i32
</code></pre>
<p>And here you can actually see what the problem is. It's a signature mismatch.</p>
</div>
<p>Remember that all function parameters of Flint are implicitely <code>const</code> except marked as <code>mut</code> explicitely, and that's exactly the mismatch happening here. The <code>fip-c</code> module found the function <code>int add(int x, int y)</code> which has the signature <code>add(mut i32, mut i32) -&gt; i32</code> in C, and we expected to find a function <code>add(const i32, const i32) -&gt; i32</code> defined in Flint. To resolve this problem we either need to edit the C code or edit the signature of our Flint function. Often times you will deal with C libraries you will not be able to change, so changing the Flint function signature would be your only option in such cases, so we now simply change this line:</p>
<pre><code class="language-ft">extern def add(i32 x, i32 y) -&gt; i32;
</code></pre>
<p>to this line:</p>
<pre><code class="language-ft">extern def add(mut i32 x, mut i32 y) -&gt; i32;
</code></pre>
<p>And now when we compile and run the program we will get this output:</p>
<blockquote>
<pre><code>Hello from C!
add(1, 8) = 9
</code></pre>
</blockquote>
<p>As you can see, it is very important that signatures match exactly when calling extern functions. Matching signatures is the basis of FIP, and we will talk more about which Flint types relate to which C types so that you do not need to wonder what went wrong.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../beginners_guide/11_interop/2_defining.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../beginners_guide/11_interop/4_signatures.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../beginners_guide/11_interop/2_defining.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../beginners_guide/11_interop/4_signatures.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../version_select.js"></script>


    </div>
    </body>
</html>
