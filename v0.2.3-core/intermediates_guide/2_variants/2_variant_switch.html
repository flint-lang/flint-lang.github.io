<!DOCTYPE HTML>
<html lang="en" class="flint sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Switching on Variants - The Flint Wiki</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/flint.css">
        <link rel="stylesheet" href="../../theme/flint-highlight.css">
        <link rel="stylesheet" href="../../version_select.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "flint";
            const default_dark_theme = "flint";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('flint')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Flint Wiki</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="switching-on-variants"><a class="header" href="#switching-on-variants">Switching on Variants</a></h1>
<p>In the last chapter we have looked at how to define variant types, but now we come to the fun part of variants, actually using them. You see, because a variant <em>can</em> be one of our defined types we also need to check which one it actually <em>is</em> before we can safely access the data that's stored within that variant. The easiest apporach to extract a variant's value is through a switch statement. Here is a small example of that:</p>
<pre><code class="language-ft">use Core.print

variant MyVariant:
	i32, f32, u64;

def print_var(MyVariant var):
	switch var:
		i32(i): print($"holds i32 value of {i}\n");
		f32(f): print($"holds f32 value of {f}\n");
		u64(u): print($"holds u64 value of {u}\n");

def main():
	MyVariant var = -5;
	print_var(var);

	var = 3.4;
	print_var(var);

	var = u64(55);
	print_var(var);
</code></pre>
<p>This program will print these lines to the console:</p>
<blockquote>
<pre><code>holds i32 value of -5
holds f32 value of 3.4
holds u64 value of 55
</code></pre>
</blockquote>
<p>There is quite a lot to unpack here. First, we pass the variant to the function. Variants are considere complex data types in Flint, this means they are passed by <strong>reference</strong>, <em>not</em> by <strong>value</strong>. This also means that changes to the variant within a function would result in these changes taking effect over at the callside of the function as well. You can see this behaviour in this example here:</p>
<pre><code class="language-ft">use Core.print

variant MyVariant:
	i32, f32, u64;

def print_var(MyVariant var):
	switch var:
		i32(i): print($"holds i32 value of {i}\n");
		f32(f): print($"holds f32 value of {f}\n");
		u64(u): print($"holds u64 value of {u}\n");

def set_i32(mut MyVariant var, i32 value):
	var = value;

def set_f32(mut MyVariant var, f32 value):
	var = value;

def set_u64(mut MyVariant var, u64 value):
	var = value;

def main():
	MyVariant var = -5;
	set_i32(var, -10);
	print_var(var);

	set_f32(var, 3.4);
	print_var(var);

	set_u64(var, u64(55));
	print_var(var);
</code></pre>
<p>This program will print these lines to the console:</p>
<blockquote>
<pre><code>holds i32 value of -10
holds f32 value of 3.4
holds u64 value of 55
</code></pre>
</blockquote>
<p>But we need to discuss one more thing here and now: naming. You see that the accessor-variables of the variant have been named <code>i</code>, <code>f</code> and <code>u</code>. You actually do not need to give them separate accessing-names, because these "variables" will only be accessible within their respective switch branch:</p>
<pre><code class="language-ft">use Core.print

variant MyVariant:
	i32, f32, u64;

def main():
	MyVariant var = -10;
	switch var:
		i32(v): print($"holds i32 value of {v}\n");
		f32(v): print($"holds f32 value of {v}\n");
		u64(v): print($"holds u64 value of {v}\n");
</code></pre>
<p>This program will print this line to the console:</p>
<blockquote>
<pre><code>holds i32 value of -10
</code></pre>
</blockquote>
<p>As you can see, you can name your value references however you like and their names will not collide. Again, just like with the value reference for optionals, you can mess up everything by setting the variant value you are switching on while you are still on one branch. This will be resolved eventually, but it also works at this point in time for variants:</p>
<pre><code class="language-ft">use Core.print

variant MyVariant:
	bool8, u8, i32;

def main():
	bool8 b8 = 'A';
	MyVariant var = b8;
	switch var:
		bool8(v):
			print($"holds bool8 value of {v}\n");
			var = 47;
			print($"holds bool8 value of {v}\n");
		u8(v): print($"holds u8 value of {v}\n");
		i32(v): print($"holds i32 value of {v}\n");
</code></pre>
<p>This program will print these lines to the console:</p>
<blockquote>
<pre><code>holds bool8 value of 01000001
holds bool8 value of 00101111
</code></pre>
</blockquote>
<p>This is actually a bit more dangerous than the same behaviour with optionals. In optionals, the value is just set to <code>0</code> through and thgough, leading to nullpointers etc. But here we could have a variant that can hold both an <code>u64</code> and a <code>str</code>, but the <code>str</code> is a pointer under the hood. This means that we can store a <code>u64</code> value in the variant inside the <code>str</code> branch and then we could point to <em>any</em> memory address and possibly read strings from it. So, while this problem seemed to be only a small one for optionals, it's actually quite a large problem for variants, so this definitely needs to be fixed at some point.</p>
<p>I need to pre-empt this here, but currently through this we are also allowed to do some shenanigans, like native bitmasking for example. But for the following example i pre-empt tagged variants a bit, just bare with me for a second, you will understand what's going on down here by the next chapter!</p>
<pre><code class="language-ft">use Core.print

variant BitMask:
	Bits(bool8, bool8, bool8, bool8), Value(u32);

def main():
	bool8 empty = '0';
	data&lt;bool8, bool8, bool8, bool8&gt; b8 = (empty, empty, empty, empty);
	BitMask var = b8;
	switch var:
		BitMask.Bits(b):
			print($"BitMask: {b.$0} {b.$1} {b.$2} {b.$3}\n");
			var = u32(1665025);
			print($"BitMask: {b.$0} {b.$1} {b.$2} {b.$3}\n");
		BitMask.Value(v): print($"holds u64 value of {v}\n");
</code></pre>
<p>This program prints these lines to the console:</p>
<blockquote>
<pre><code>BitMask: 00110000 00110000 00110000 00110000
BitMask: 00000001 01101000 00011001 00000000
</code></pre>
</blockquote>
<p>And as you can see, the above mentioned problem can also be a feature. It's quite a lot more nuanced than just saying it's just bad, because now we can do bitmasking with it, without any temporaries, as the accessors are references to the same value. So, if the bitmask and the actual value have the same width, like in our case, both are <code>4</code> bytes in size, we can do pretty cool stuff with variants, as we can directly modify the memory in the <code>value</code> field and interpret it as a whole number or a mask where we can access each individual element.</p>
<p>So, whether this is a bug or a feature is open to debate, but in my opinion it could be a feature <em>if</em> <strong>none</strong> of the possible types are complex and thus are pointers under the hood. If all values are <em>real</em> values and not pointers under the hood i can't see why this should not be allowed for variants, as it's a pretty exploitable system for sure. And if no pointer can be stored in the variant, nothing can be accessed or written to at an arbitrary point in memory, which means the program will definitely not crash, it could only happen that you will get the wrong or unexpected values if you do exploit this. I think there should be a warning that mutating the variable inside the branch could lead to problems, but there should only be a compile-error if one of the variant's types is complex.</p>
<p>I cannot really think of a practical use case of this implication, honestly, especially since Flint will support shift operators <code>&lt;&lt;</code>, <code>&gt;&gt;</code> and bitwise operators like <code>|</code>, <code>&amp;</code> and <code>!</code> as well in the future, so bitmasking for example is not really needed and useful when we have access to direct bit-manipulation as well.</p>
<p>And switch expressions work exactly the same way, just with a <code>-&gt;</code> instead of the <code>:</code> and with no scope but a single expression after the arrow, as usual. But now let's move on to the next chapter of tagging.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../intermediates_guide/2_variants/1_introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../intermediates_guide/2_variants/3_tagged.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../intermediates_guide/2_variants/1_introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../intermediates_guide/2_variants/3_tagged.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../version_select.js"></script>


    </div>
    </body>
</html>
